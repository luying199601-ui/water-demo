<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·-æ²³-æ¹–-åº“æ ¸äº‹æ•…åº”æ€¥è¯„ä»·æ¨¡æ‹Ÿç³»ç»Ÿ | WECAS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-velocity/dist/leaflet-velocity.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* === æ ·å¼åŒºåŸŸ (ä¿æŒä¹‹å‰çš„ç¾è§‚è®¾è®¡) === */
        :root {
            --primary: #00f2ff;
            --bg-dark: #0a0e14;
            --bg-panel: #131924;
            --bg-card: #1c2433;
            --glass-bg: rgba(12, 24, 40, 0.9);
            --glass-border: 1px solid rgba(0, 242, 255, 0.3);
            --text-white: #ffffff;
            --text-gray: #8b9bb4;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); overflow: hidden; color: var(--text-white); }
        
        /* é€šç”¨ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }
        input, select { background: rgba(0,0,0,0.3); border: 1px solid #334155; color: #fff; padding: 8px 12px; border-radius: 4px; outline: none; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(0,242,255,0.2); }

        /* ç™»å½•é¡µ */
        #login-page { position: absolute; inset: 0; background: radial-gradient(circle at center, #1a2a3a 0%, #000 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .login-box { width: 400px; padding: 40px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: var(--glass-border); border-radius: 12px; text-align: center; }

        /* ä¸»å®¹å™¨ */
        #main-interface { display: none; width: 100%; height: 100%; position: relative; }
        .content-wrapper { position: absolute; inset: 0; z-index: 1; display: none; background: #000; }
        .content-wrapper.active { display: block; animation: fadeInView 0.3s; }
        @keyframes fadeInView { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* åœ°å›¾å±‚ */
        #map-container { width: 100%; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; background: #000; z-index: 1; cursor: crosshair; }
        .ui-layer { z-index: 2000; position: absolute; pointer-events: auto; }

        /* å“ç‰Œ */
        .floating-brand {
            top: 20px; left: 20px; padding: 10px 20px;
            background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px); border-radius: 30px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: none;
        }
        .brand-logo { color: var(--primary); font-size: 20px; animation: spinSlow 10s linear infinite; }
        .brand-text { font-weight: bold; font-size: 16px; letter-spacing: 1px; color: #fff; }
        @keyframes spinSlow { 100% { transform: rotate(360deg); } }

        /* === çœŸå®æœç´¢æ¡†æ ·å¼ === */
        .home-search-bar {
            top: 30px; left: 50%; transform: translateX(-50%);
            width: 500px; display: flex; flex-direction: column; align-items: center;
        }
        .search-container { width: 100%; position: relative; }
        .search-input-lg {
            width: 100%; padding: 12px 50px 12px 25px;
            background: var(--glass-bg); border: var(--glass-border);
            backdrop-filter: blur(8px); border-radius: 30px;
            color: white; font-size: 15px; outline: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); transition: all 0.3s;
        }
        .search-input-lg:focus { box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); border-color: var(--primary); border-radius: 20px 20px 0 0; }
        
        .search-icon-btn { 
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
            background: none; border: none; color: var(--primary); font-size: 16px; cursor: pointer;
        }
        
        /* è”æƒ³ä¸‹æ‹‰æ¡† */
        .search-suggestions {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: rgba(12, 24, 40, 0.95); border: var(--glass-border); border-top: none;
            border-radius: 0 0 20px 20px; display: none;
            max-height: 300px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .suggestion-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
        .suggestion-item:hover { background: rgba(0, 242, 255, 0.1); }
        .s-name { font-size: 14px; color: #fff; font-weight: bold; }
        .s-desc { font-size: 12px; color: #888; margin-top: 3px; }

        /* Dock èœå• */
        .home-dock {
            bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 30px; padding: 12px 40px;
            background: var(--glass-bg); border: var(--glass-border);
            backdrop-filter: blur(10px); border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .dock-btn {
            display: flex; flex-direction: column; align-items: center;
            background: transparent; border: none;
            color: rgba(255,255,255,0.7); cursor: pointer;
            transition: all 0.2s; width: 60px;
        }
        .dock-btn:hover { color: var(--primary); transform: translateY(-5px); }
        .dock-icon { font-size: 24px; margin-bottom: 6px; }
        .dock-label { font-size: 12px; font-weight: 500; }

        /* å·¥å…·æ  */
        .map-tools-right { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 2001; }
        .tool-btn { width: 40px; height: 40px; background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .tool-btn:hover { color: var(--primary); border-color: var(--primary); transform: scale(1.1); }

        /* åº•å›¾é¢æ¿ */
        .basemap-panel { position: absolute; top: 0; right: 60px; width: 220px; background: rgba(20, 25, 35, 0.95); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 8px; padding: 10px 0; display: none; z-index: 2001; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .basemap-panel.show { display: block; animation: slideInRight 0.3s; }
        .layer-item { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .layer-item:hover { background: rgba(255,255,255,0.05); }
        .toggle-switch { width: 30px; height: 16px; background: #444; border-radius: 20px; position: relative; }
        .toggle-switch::after { content:''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .layer-item.active .toggle-switch { background: var(--primary); }
        .layer-item.active .toggle-switch::after { transform: translateX(14px); }

        /* å­é¡µé¢æ ·å¼ */
        .subpage-layout { display: flex; height: 100%; flex-direction: column; background: var(--bg-dark); }
        .subpage-header { height: 60px; background: var(--bg-panel); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .subpage-title { font-size: 18px; font-weight: bold; color: #fff; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px 20px; border-radius: 30px; display: flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: var(--primary); color: #000; border-color: var(--primary); }
        .subpage-body { flex: 1; display: flex; overflow: hidden; }
        .admin-sidebar { width: 220px; background: #131924; border-right: 1px solid rgba(255,255,255,0.05); padding-top: 20px; }
        .menu-title { padding: 10px 20px; color: #5c6b7f; font-size: 12px; font-weight: bold; }
        .menu-item { padding: 12px 20px; display: flex; align-items: center; gap: 10px; color: var(--text-gray); cursor: pointer; transition: 0.2s; font-size: 14px; }
        .menu-item:hover, .menu-item.active { background: rgba(0,242,255,0.05); color: var(--text-white); border-right: 3px solid var(--primary); }
        .admin-content { flex: 1; padding: 30px; overflow-y: auto; }
        .panel-box { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 25px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { text-align: left; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd; font-size: 14px; }

        /* Popup */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: rgba(10, 20, 30, 0.95) !important; border: 1px solid var(--primary) !important; color: white !important; }
        .create-task-btn-sm { background: var(--primary); color: #000; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; width: 100%; margin-top: 10px; }

        /* å¼¹çª— */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-window { width: 900px; height: 750px; background: #0f141e; border: 1px solid var(--primary); border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,242,255,0.15); }
        .modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,242,255,0.05); }
        .step-bar { display: flex; padding: 20px 40px; background: #0b0f16; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .step-item { display: flex; align-items: center; color: #444; margin-right: 30px; }
        .step-item.active { color: var(--primary); font-weight: bold; }
        .step-circle { width: 24px; height: 24px; border: 2px solid #444; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 8px; font-size: 12px; }
        .step-item.active .step-circle { border-color: var(--primary); background: rgba(0,242,255,0.2); }
        .form-section { display: none; padding: 30px; flex: 1; overflow-y: auto; }
        .form-section.active { display: block; animation: fadeIn 0.3s; }
        .chain-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px; }
        .chain-card { border: 1px solid #333; padding: 20px; border-radius: 8px; cursor: pointer; background: rgba(255,255,255,0.02); display: flex; gap: 15px; align-items: flex-start; }
        .chain-card.selected { border-color: var(--primary); background: rgba(0,242,255,0.1); }
        .modal-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; gap: 15px; background: #0b0f16; }
        .btn-primary { background: var(--primary); color: #000; border: none; padding: 10px 30px; border-radius: 4px; font-weight: bold; }
        .btn-secondary { background: #333; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:30px; letter-spacing:2px;">WECAS 2.0</h2>
            <input type="text" id="username" placeholder="ç”¨æˆ·å: admin" value="admin" style="margin-bottom:15px;">
            <input type="password" id="password" placeholder="å¯†ç : 123456" value="123456" style="margin-bottom:20px;">
            <button onclick="login()" style="width:100%; padding:12px; background:linear-gradient(90deg, #00c6ff, #0072ff); border:none; color:white; border-radius:4px; font-weight:bold;">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
    </div>

    <div id="main-interface">
        
        <div id="view-map" class="content-wrapper active">
            <div id="map-container">
                <div id="map"></div>
                
                <div class="ui-layer floating-brand">
                    <i class="fas fa-atom fa-spin brand-logo"></i>
                    <span class="brand-text">WECAS 2.0</span>
                </div>

                <div class="ui-layer home-search-bar">
                    <div class="search-container">
                        <input type="text" class="search-input-lg" id="search-input" 
                               placeholder="ğŸ” è¾“å…¥çœŸå®åœ°ç‚¹ (å¦‚ï¼šBeijing, New York, é•¿æ±Ÿå£)..." 
                               oninput="handleSearchInput(this.value)">
                        <button class="search-icon-btn" onclick="triggerSearch()"><i class="fas fa-search"></i></button>
                        <div class="search-suggestions" id="search-suggestions"></div>
                    </div>
                </div>

                <div class="map-tools-right">
                    <button class="tool-btn" onclick="toggleBasemapPanel()" title="å›¾å±‚ç®¡ç†"><i class="fas fa-layer-group"></i></button>
                    <div class="basemap-panel" id="basemap-panel">
                        <div style="padding:0 15px 10px; border-bottom:1px solid #333; font-weight:bold; font-size:14px; display:flex; justify-content:space-between;">
                            <span>åº•å›¾åˆ‡æ¢</span><i class="fas fa-times" style="cursor:pointer;" onclick="toggleBasemapPanel()"></i>
                        </div>
                        <div class="layer-item" onclick="switchLayer('dark', this)"><span class="layer-name">CartoDB æš—è‰²</span><div class="toggle-switch"></div></div>
                        <div class="layer-item active" onclick="switchLayer('satellite', this)"><span class="layer-name">ESRI å«æ˜Ÿå½±åƒ</span><div class="toggle-switch"></div></div>
                    </div>
                    <button class="tool-btn" onclick="alert('æµ‹è·å·¥å…·')" title="æµ‹è·"><i class="fas fa-ruler"></i></button>
                    <button class="tool-btn" onclick="openTaskModal(false)" title="åˆ›å»ºä»»åŠ¡"><i class="fas fa-plus" style="color:var(--primary)"></i></button>
                </div>

                <div class="ui-layer home-dock">
                    <button class="dock-btn" onclick="openTaskModal(false)"><span class="dock-icon"><i class="fas fa-plus-circle"></i></span><span class="dock-label">åˆ›å»ºä»»åŠ¡</span></button>
                    <button class="dock-btn" onclick="switchView('task')"><span class="dock-icon"><i class="fas fa-clipboard-list"></i></span><span class="dock-label">ä»»åŠ¡åˆ—è¡¨</span></button>
                    <button class="dock-btn" onclick="switchView('data')"><span class="dock-icon"><i class="fas fa-server"></i></span><span class="dock-label">æ•°æ®ä¸­å¿ƒ</span></button>
                    <button class="dock-btn" onclick="switchView('ops')"><span class="dock-icon"><i class="fas fa-chart-line"></i></span><span class="dock-label">è¿ç»´ç›‘æ§</span></button>
                </div>
            </div>
        </div>

        <div id="view-task" class="content-wrapper">
            <div class="subpage-layout">
                <div class="subpage-header">
                    <div class="subpage-title"><i class="fas fa-clipboard-list"></i> å†å²ä»»åŠ¡ç®¡ç†</div>
                    <button class="back-btn" onclick="switchView('map')"><i class="fas fa-arrow-left"></i> è¿”å›åœ°å›¾</button>
                </div>
                <div style="flex:1; padding:30px; overflow-y:auto;">
                    <div style="color:#aaa; text-align:center; padding:20px;">è¿™é‡Œæ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨ (é€»è¾‘ä¸ä¹‹å‰ä¸€è‡´)</div>
                </div>
            </div>
        </div>

        <div id="view-data" class="content-wrapper">
            <div class="subpage-layout">
                <div class="subpage-header">
                    <div class="subpage-title"><i class="fas fa-database"></i> æ•°æ®ç®¡ç†ä¸­å¿ƒ</div>
                    <button class="back-btn" onclick="switchView('map')"><i class="fas fa-arrow-left"></i> è¿”å›åœ°å›¾</button>
                </div>
                <div class="subpage-body">
                    <div class="admin-sidebar">
                        <div class="menu-group">
                            <div class="menu-title">æ•°æ®ç›®å½•</div>
                            <div class="menu-item active"><i class="fas fa-map-marker-alt"></i> æ ¸è®¾æ–½ç®¡ç†</div>
                            <div class="menu-item"><i class="fas fa-layer-group"></i> åŸºç¡€æ•°æ®</div>
                        </div>
                    </div>
                    <div class="admin-content">
                        <div class="panel-box">
                            <h3>æ ¸è®¾æ–½ä¸æ¨¡å¼é“¾é…ç½®</h3>
                            <table class="data-table">
                                <thead><tr><th>è®¾æ–½åç§°</th><th>ä½ç½®</th><th>æ¨¡å¼</th><th>æ“ä½œ</th></tr></thead>
                                <tbody>
                                    <tr><td>ç§¦å±±æ ¸ç”µç«™</td><td>120.94, 30.43</td><td>è¿‘æµ·ç²¾ç»†</td><td><button style="color:var(--primary);background:none;border:none">é…ç½®</button></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-ops" class="content-wrapper">
            <div class="subpage-layout">
                <div class="subpage-header">
                    <div class="subpage-title"><i class="fas fa-cogs"></i> è¿ç»´ç›‘æ§ä¸­å¿ƒ</div>
                    <button class="back-btn" onclick="switchView('map')"><i class="fas fa-arrow-left"></i> è¿”å›åœ°å›¾</button>
                </div>
                <div class="subpage-body">
                    <div class="admin-sidebar">
                        <div class="menu-group"><div class="menu-title">ç›‘æ§é¡¹</div><div class="menu-item active"><i class="fas fa-file-alt"></i> ç³»ç»Ÿæ—¥å¿—</div></div>
                    </div>
                    <div class="admin-content"><div class="panel-box"><h3>ç³»ç»Ÿæ—¥å¿—</h3><div>æ—¥å¿—åŠ è½½ä¸­...</div></div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="task-modal">
        <div class="modal-window">
            <div class="modal-header"><span>åˆ›å»ºä»»åŠ¡</span><button onclick="closeTaskModal()" style="background:none;border:none;color:#fff;">&times;</button></div>
            <div style="padding:20px; text-align:center;">è¿™é‡Œæ˜¯ä»»åŠ¡åˆ›å»ºå‘å¯¼...</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-velocity/dist/leaflet-velocity.js"></script>
    <script>
        let map;
        let currentMarker = null;
        let baseLayers = {};
        let currentLayer = null;
        let velocityLayer = null;
        let searchTimeout = null;

        function login() {
            document.getElementById('login-page').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-interface').style.display = 'block';
                initMap();
            }, 500);
        }

        function switchView(viewName) {
            document.querySelectorAll('.content-wrapper').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            if(viewName === 'map' && map) setTimeout(() => map.invalidateSize(), 100);
        }

        function initMap() {
            if(map) return;
            baseLayers = {
                'dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18, opacity:0.9 }),
                'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:18 })
            };
            map = L.map('map', { center: [30.4, 122.5], zoom: 7, zoomControl: false, layers: [baseLayers['satellite']] });
            currentLayer = baseLayers['satellite'];
            
            // ç»‘å®šå›è½¦
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if(e.key === 'Enter') triggerSearch();
            });

            loadWindData();
        }

        // ============================
        // æ ¸å¿ƒä¿®å¤ï¼šçœŸå® API æœç´¢é€»è¾‘
        // ============================
        async function triggerSearch() {
            const query = document.getElementById('search-input').value;
            if(!query) return;

            // 1. UI åé¦ˆï¼šè½¬åœˆ
            const btn = document.querySelector('.search-icon-btn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // 2. è°ƒç”¨ OpenStreetMap Nominatim çœŸå®æ¥å£
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                // 3. å¤„ç†ç»“æœ
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    const name = data[0].display_name.split(',')[0]; // å–ç®€çŸ­åå­—
                    
                    // éšè—è”æƒ³æ¡†
                    document.getElementById('search-suggestions').style.display = 'none';
                    
                    // æ‰§è¡Œè·³è½¬
                    selectLocation(lat, lon, name);
                } else {
                    alert("æœªæ‰¾åˆ°åœ°ç‚¹ï¼Œè¯·å°è¯•è¾“å…¥è‹±æ–‡æˆ–æ›´è¯¦ç»†çš„ä¸­æ–‡åœ°å");
                }
            } catch (e) {
                console.error(e);
                alert("æœç´¢æœåŠ¡è¿æ¥å¤±è´¥ (è¯·æ£€æŸ¥ç½‘ç»œ)");
            } finally {
                btn.innerHTML = '<i class="fas fa-search"></i>'; // æ¢å¤å›¾æ ‡
            }
        }

        // è”æƒ³è¾“å…¥é€»è¾‘ (æ··åˆæ¨¡å¼ï¼šæœ¬åœ°æ ¸ç”µç«™ + APIæç¤º)
        function handleSearchInput(query) {
            const list = document.getElementById('search-suggestions');
            if(!query) { list.style.display = 'none'; return; }

            // æœ¬åœ°é«˜ä¼˜æ•°æ® (æ ¸è®¾æ–½)
            const localDB = [
                { name: 'ç§¦å±±æ ¸ç”µç«™', lat: 30.435, lng: 120.941, desc: 'æµ™æ±Ÿçœ' },
                { name: 'å¤§äºšæ¹¾æ ¸ç”µç«™', lat: 22.59, lng: 114.54, desc: 'å¹¿ä¸œçœ' },
                { name: 'ä¸‰é—¨æ ¸ç”µç«™', lat: 29.10, lng: 121.63, desc: 'æµ™æ±Ÿçœ' }
            ];
            const matches = localDB.filter(item => item.name.includes(query));

            let html = matches.map(m => `
                <div class="suggestion-item" onclick="selectLocation(${m.lat}, ${m.lng}, '${m.name}')">
                    <div class="s-name">${m.name}</div>
                    <div class="s-desc"><i class="fas fa-map-marker-alt"></i> ${m.desc} (é¢„è®¾)</div>
                </div>
            `).join('');

            // æ·»åŠ ä¸€ä¸ªâ€œå»äº‘ç«¯æœç´¢â€çš„é€‰é¡¹
            html += `
                <div class="suggestion-item" onclick="triggerSearch()">
                    <div class="s-name">æœç´¢ "${query}"</div>
                    <div class="s-desc"><i class="fas fa-cloud"></i> ç‚¹å‡»æœç´¢å…¨çƒåœ°ç‚¹...</div>
                </div>
            `;

            list.innerHTML = html;
            list.style.display = 'block';
        }

        function selectLocation(lat, lng, name) {
            document.getElementById('search-suggestions').style.display = 'none';
            document.getElementById('search-input').value = name;
            
            map.flyTo([lat, lng], 10);
            
            if(currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`
                    <div style="font-weight:bold; color:#00f2ff; margin-bottom:5px;">${name}</div>
                    <div style="font-size:12px; color:#ccc;">LAT: ${lat.toFixed(3)} | LON: ${lng.toFixed(3)}</div>
                    <button class="create-task-btn-sm" onclick="openTaskModal(true)">âš¡ åœ¨æ­¤åˆ›å»ºä»»åŠ¡</button>
                `, { className: 'custom-popup' }).openPopup();
        }

        function loadWindData() {
            fetch('wind-global.json').then(r => r.json()).then(data => {
                velocityLayer = L.velocityLayer({
                    displayValues: true,
                    displayOptions: { velocityType: 'Current', displayPosition: 'bottomleft', angleConvention: 'bearingCW' },
                    data: data, maxVelocity: 2.0, velocityScale: 0.1, 
                    colorScale: ["#ffffff", "#b3e5fc", "#4fc3f7", "#03a9f4"], lineWidth: 2
                });
                velocityLayer.addTo(map);
            }).catch(e => console.log('ç²’å­æ•°æ®åŠ è½½å¤±è´¥'));
        }

        function toggleBasemapPanel() { document.getElementById('basemap-panel').classList.toggle('show'); }
        function switchLayer(type, el) {
            document.querySelectorAll('.layer-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');
            if(currentLayer) map.removeLayer(currentLayer);
            currentLayer = baseLayers[type];
            map.addLayer(currentLayer);
            if(velocityLayer) { velocityLayer.remove(); velocityLayer.addTo(map); }
        }

        // å¼¹çª—ç®€å•é€»è¾‘
        function openTaskModal(fromMap) { document.getElementById('task-modal').style.display = 'flex'; }
        function closeTaskModal() { document.getElementById('task-modal').style.display = 'none'; }
    </script>
</body>
</html>
